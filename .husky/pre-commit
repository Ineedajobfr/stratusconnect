#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”’ Running security checks..."

# Run Gitleaks to check for secrets
echo "ğŸ” Checking for secrets with Gitleaks..."
if command -v gitleaks >/dev/null 2>&1; then
    gitleaks protect --verbose --staged
    if [ $? -ne 0 ]; then
        echo "âŒ Gitleaks found potential secrets in staged files"
        echo "Please remove or encrypt any secrets before committing"
        exit 1
    fi
else
    echo "âš ï¸  Gitleaks not found. Install with: brew install gitleaks"
fi

# Run ESLint security checks
echo "ğŸ”§ Running ESLint security checks..."
npm run lint:security
if [ $? -ne 0 ]; then
    echo "âŒ ESLint security checks failed"
    echo "Please fix security issues before committing"
    exit 1
fi

# Run npm audit
echo "ğŸ“¦ Running npm audit..."
npm audit --audit-level=high
if [ $? -ne 0 ]; then
    echo "âŒ npm audit found high/critical vulnerabilities"
    echo "Please fix vulnerabilities before committing"
    exit 1
fi

# Type check
echo "ğŸ” Running TypeScript type check..."
npm run type-check
if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type check failed"
    echo "Please fix type errors before committing"
    exit 1
fi

echo "âœ… All security checks passed!"